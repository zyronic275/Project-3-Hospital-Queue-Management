<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Antrean Rumah Sakit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .view { display: none; }
        .view.active { display: block; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4">
        <header class="bg-white shadow rounded-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Dasbor Manajemen Antrean Rumah Sakit</h1>
            <p class="text-gray-600">Pusat kontrol untuk pendaftaran, administrasi, dan monitoring.</p>
        </header>

        <!-- Navigasi Tab -->
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button onclick="switchView('dashboard')" class="tab-button active-tab text-blue-600 py-4 px-1 border-b-2 border-blue-600 font-medium" data-view="dashboard">
                    <i class="fas fa-tachometer-alt mr-2"></i>Monitoring
                </button>
                <button onclick="switchView('admin')" class="tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 border-b-2 border-transparent font-medium" data-view="admin">
                    <i class="fas fa-user-shield mr-2"></i>Manajemen Admin
                </button>
                <button onclick="switchView('registration')" class="tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 border-b-2 border-transparent font-medium" data-view="registration">
                    <i class="fas fa-edit mr-2"></i>Pendaftaran Pasien
                </button>
                 <button onclick="switchView('public')" class="tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 border-b-2 border-transparent font-medium" data-view="public">
                    <i class="fas fa-tv mr-2"></i>Layar Antrean Publik
                </button>
            </nav>
        </div>

        <main>
            <!-- View: Dashboard Monitoring -->
            <div id="dashboard-view" class="view active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="dashboard-grid">
                    <!-- Data dasbor akan dimuat di sini -->
                </div>
            </div>

            <!-- View: Manajemen Admin -->
            <div id="admin-view" class="view">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Manajemen Layanan -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-700">Manajemen Layanan (Klinik)</h2>
                            <button onclick="openServiceModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow">
                                <i class="fas fa-plus mr-2"></i>Tambah
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prefix</th>
                                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="service-table-body" class="divide-y divide-gray-200">
                                    <!-- Data layanan akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Manajemen Dokter -->
                    <div class="bg-white p-6 rounded-lg shadow">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-700">Manajemen Dokter</h2>
                             <button onclick="openDoctorModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow">
                                <i class="fas fa-plus mr-2"></i>Tambah
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Praktik</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kuota</th>
                                        <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="doctor-table-body" class="divide-y divide-gray-200">
                                    <!-- Data dokter akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Pendaftaran Pasien -->
            <div id="registration-view" class="view">
                 <div class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">Form Pendaftaran Pasien Baru</h2>
                    <form id="registration-form">
                        <div class="mb-4">
                            <label for="patient-name" class="block text-gray-700 text-sm font-bold mb-2">Nama Pasien</label>
                            <input type="text" id="patient-name" name="patient_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Pilih Layanan (Klinik)</label>
                            <div id="service-options-container" class="grid grid-cols-2 gap-4">
                                <!-- Opsi layanan akan dimuat di sini -->
                            </div>
                        </div>
                        <div class="flex items-center justify-center">
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow">
                                <i class="fas fa-paper-plane mr-2"></i>Daftarkan Pasien
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- View: Layar Antrean Publik -->
            <div id="public-view" class="view">
                <div class="mb-4">
                    <label for="clinic-select" class="block text-gray-700 text-sm font-bold mb-2">Pilih Klinik untuk Ditampilkan:</label>
                    <select id="clinic-select" onchange="fetchQueueForClinic(this.value)" class="shadow border rounded w-full md:w-1/3 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Opsi klinik akan dimuat di sini -->
                    </select>
                </div>
                <div id="queue-display" class="bg-white p-6 rounded-lg shadow">
                    <h2 id="queue-clinic-name" class="text-2xl font-bold text-center mb-4">Pilih sebuah klinik</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-semibold text-lg border-b pb-2 mb-2 text-yellow-600">Menunggu</h3>
                            <ul id="waiting-list" class="list-disc pl-5 space-y-1"></ul>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg border-b pb-2 mb-2 text-green-600">Sedang Dilayani</h3>
                            <ul id="serving-list" class="list-disc pl-5 space-y-1"></ul>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal untuk Layanan -->
    <div id="service-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="service-modal-title" class="text-2xl font-bold mb-4">Tambah Layanan</h2>
            <form id="service-form">
                <input type="hidden" id="service-id">
                <div class="mb-4">
                    <label for="service-name" class="block text-gray-700 text-sm font-bold mb-2">Nama Layanan</label>
                    <input type="text" id="service-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="service-prefix" class="block text-gray-700 text-sm font-bold mb-2">Prefix (1 Huruf)</label>
                    <input type="text" id="service-prefix" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required maxlength="1">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeServiceModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Batal</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal untuk Dokter -->
    <div id="doctor-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h2 id="doctor-modal-title" class="text-2xl font-bold mb-4">Tambah Dokter</h2>
            <form id="doctor-form">
                 <input type="hidden" id="doctor-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="doctor-name" class="block text-gray-700 text-sm font-bold mb-2">Nama Dokter</label>
                        <input type="text" id="doctor-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div class="mb-4">
                        <label for="doctor-code" class="block text-gray-700 text-sm font-bold mb-2">Kode Dokter</label>
                        <input type="text" id="doctor-code" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                     <div class="mb-4">
                        <label for="practice-start-time" class="block text-gray-700 text-sm font-bold mb-2">Mulai Praktik</label>
                        <input type="time" id="practice-start-time" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div class="mb-4">
                        <label for="practice-end-time" class="block text-gray-700 text-sm font-bold mb-2">Selesai Praktik</label>
                        <input type="time" id="practice-end-time" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div class="mb-4">
                        <label for="max-patients" class="block text-gray-700 text-sm font-bold mb-2">Kuota Pasien</label>
                        <input type="number" id="max-patients" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required min="1">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Layanan yang Ditangani</label>
                    <div id="doctor-service-options" class="grid grid-cols-2 gap-2">
                        <!-- Opsi layanan untuk dokter -->
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeDoctorModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Batal</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Notifikasi/Alert Sederhana -->
    <div id="alert-notification" class="hidden fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg">
        <p id="alert-message"></p>
    </div>


<script>
const API_BASE_URL = 'http://127.0.0.1:8000'; 
let servicesCache = [];
let doctorsCache = [];

// --- UTILITIES & API HELPERS ---

async function apiRequest(endpoint, method = 'GET', body = null) {
    const options = {
        method,
        headers: {
            'Content-Type': 'application/json',
        },
    };
    if (body) {
        options.body = JSON.stringify(body);
    }
    try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
        }
        if (response.status === 204) { // No Content
            return null;
        }
        return await response.json();
    } catch (error) {
        console.error(`API request failed: ${method} ${endpoint}`, error);
        showAlert(`Error: ${error.message}`, 'error');
        throw error;
    }
}

function showAlert(message, type = 'success') {
    const alertDiv = document.getElementById('alert-notification');
    const messageP = document.getElementById('alert-message');
    
    messageP.textContent = message;
    alertDiv.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
    alertDiv.classList.remove('hidden');

    setTimeout(() => {
        alertDiv.classList.add('hidden');
    }, 3000);
}

// --- VIEW SWITCHING ---

function switchView(viewName) {
    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
    document.getElementById(`${viewName}-view`).classList.add('active');
    
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
        button.classList.add('text-gray-500', 'hover:text-gray-700', 'border-transparent');
    });
    const activeButton = document.querySelector(`.tab-button[data-view="${viewName}"]`);
    activeButton.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
    activeButton.classList.remove('text-gray-500', 'hover:text-gray-700', 'border-transparent');
    
    if (viewName === 'public') {
        const firstClinicId = document.querySelector('#clinic-select option')?.value;
        if(firstClinicId) fetchQueueForClinic(firstClinicId);
    }
}

// --- DASHBOARD MONITORING ---

function renderDashboard(data) {
    const grid = document.getElementById('dashboard-grid');
    grid.innerHTML = '';
    if (data.length === 0) {
        grid.innerHTML = '<p class="text-gray-500">Belum ada data klinik untuk ditampilkan.</p>';
        return;
    }
    data.forEach(clinic => {
        const percentage = Math.round(clinic.density_percentage);
        let bgColor = 'bg-green-100';
        let textColor = 'text-green-800';
        let ringColor = 'ring-green-500';

        if (percentage > 75) {
            bgColor = 'bg-red-100'; textColor = 'text-red-800'; ringColor = 'ring-red-500';
        } else if (percentage > 50) {
            bgColor = 'bg-yellow-100'; textColor = 'text-yellow-800'; ringColor = 'ring-yellow-500';
        }

        const card = `
            <div class="bg-white p-5 rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300">
                <h3 class="font-bold text-lg text-gray-800">${clinic.service_name}</h3>
                <p class="text-sm text-gray-500">${clinic.doctors_count} Dokter Bertugas</p>
                <div class="my-4">
                    <div class="flex justify-between items-center text-sm mb-1">
                        <span class="font-semibold">Kepadatan</span>
                        <span class="${textColor} font-bold">${percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="${bgColor.replace('100', '500')} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
                <div class="text-sm space-y-2 text-gray-700">
                    <div class="flex justify-between"><span>Total Pasien Hari Ini:</span> <span class="font-semibold">${clinic.total_patients_today} / ${clinic.max_patients_total}</span></div>
                    <div class="flex justify-between"><span>Menunggu:</span> <span class="font-semibold text-yellow-600">${clinic.patients_waiting}</span></div>
                    <div class="flex justify-between"><span>Dilayani:</span> <span class="font-semibold text-blue-600">${clinic.patients_serving}</span></div>
                </div>
            </div>
        `;
        grid.innerHTML += card;
    });
}

async function fetchDashboardData() {
    try {
        const data = await apiRequest('/admin/dashboard');
        renderDashboard(data);
    } catch (error) {
        // Error already handled by apiRequest
    }
}


// --- ADMIN: SERVICES ---
function renderServiceTable() {
    const tbody = document.getElementById('service-table-body');
    tbody.innerHTML = '';
    servicesCache.forEach(service => {
        const row = `
            <tr>
                <td class="py-4 px-4 whitespace-nowrap">${service.name}</td>
                <td class="py-4 px-4 whitespace-nowrap font-mono text-center bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center">${service.prefix}</td>
                <td class="py-4 px-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editService(${service.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                    <button onclick="deleteService(${service.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function openServiceModal(serviceId = null) {
    const form = document.getElementById('service-form');
    form.reset();
    document.getElementById('service-id').value = '';
    
    if (serviceId) {
        const service = servicesCache.find(s => s.id === serviceId);
        document.getElementById('service-modal-title').textContent = 'Edit Layanan';
        document.getElementById('service-id').value = service.id;
        document.getElementById('service-name').value = service.name;
        document.getElementById('service-prefix').value = service.prefix;
    } else {
        document.getElementById('service-modal-title').textContent = 'Tambah Layanan';
    }
    document.getElementById('service-modal').classList.remove('hidden');
}

function closeServiceModal() {
    document.getElementById('service-modal').classList.add('hidden');
}

async function handleServiceFormSubmit(event) {
    event.preventDefault();
    const serviceId = document.getElementById('service-id').value;
    const serviceData = {
        name: document.getElementById('service-name').value,
        prefix: document.getElementById('service-prefix').value.toUpperCase(),
    };

    try {
        if (serviceId) {
            await apiRequest(`/admin/services/${serviceId}`, 'PUT', serviceData);
            showAlert('Layanan berhasil diperbarui.');
        } else {
            await apiRequest('/admin/services/', 'POST', serviceData);
            showAlert('Layanan berhasil ditambahkan.');
        }
        closeServiceModal();
        fetchAllAdminData();
    } catch(error) {}
}

async function deleteService(serviceId) {
    if (confirm('Apakah Anda yakin ingin menghapus layanan ini?')) {
        try {
            await apiRequest(`/admin/services/${serviceId}`, 'DELETE');
            showAlert('Layanan berhasil dihapus.');
            fetchAllAdminData();
        } catch(error) {}
    }
}


// --- ADMIN: DOCTORS ---
function renderDoctorTable() {
    const tbody = document.getElementById('doctor-table-body');
    tbody.innerHTML = '';
    doctorsCache.forEach(doctor => {
        const row = `
            <tr>
                <td class="py-4 px-4 whitespace-nowrap">
                    <div class="font-medium text-gray-900">${doctor.name}</div>
                    <div class="text-sm text-gray-500">Kode: ${doctor.doctor_code}</div>
                </td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${doctor.practice_start_time.slice(0,5)} - ${doctor.practice_end_time.slice(0,5)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${doctor.max_patients}</td>
                <td class="py-4 px-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="editDoctor(${doctor.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                    <button onclick="deleteDoctor(${doctor.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function renderDoctorServiceOptions(selectedServices = []) {
    const container = document.getElementById('doctor-service-options');
    container.innerHTML = '';
    servicesCache.forEach(service => {
        const isChecked = selectedServices.includes(service.id);
        const option = `
            <label class="flex items-center space-x-2">
                <input type="checkbox" name="doctor-services" value="${service.id}" ${isChecked ? 'checked' : ''} class="form-checkbox h-5 w-5 text-blue-600">
                <span>${service.name}</span>
            </label>
        `;
        container.innerHTML += option;
    });
}

function openDoctorModal(doctorId = null) {
    const form = document.getElementById('doctor-form');
    form.reset();
    document.getElementById('doctor-id').value = '';
    
    if (doctorId) {
        const doctor = doctorsCache.find(d => d.id === doctorId);
        document.getElementById('doctor-modal-title').textContent = 'Edit Dokter';
        document.getElementById('doctor-id').value = doctor.id;
        document.getElementById('doctor-name').value = doctor.name;
        document.getElementById('doctor-code').value = doctor.doctor_code;
        document.getElementById('practice-start-time').value = doctor.practice_start_time;
        document.getElementById('practice-end-time').value = doctor.practice_end_time;
        document.getElementById('max-patients').value = doctor.max_patients;
        renderDoctorServiceOptions(doctor.services);
    } else {
        document.getElementById('doctor-modal-title').textContent = 'Tambah Dokter';
        renderDoctorServiceOptions();
    }
    document.getElementById('doctor-modal').classList.remove('hidden');
}

function closeDoctorModal() {
    document.getElementById('doctor-modal').classList.add('hidden');
}

async function handleDoctorFormSubmit(event) {
    event.preventDefault();
    const doctorId = document.getElementById('doctor-id').value;
    const selectedServices = Array.from(document.querySelectorAll('input[name="doctor-services"]:checked')).map(el => parseInt(el.value));

    if (selectedServices.length === 0) {
        showAlert('Dokter harus menangani setidaknya satu layanan.', 'error');
        return;
    }

    const doctorData = {
        name: document.getElementById('doctor-name').value,
        doctor_code: document.getElementById('doctor-code').value,
        practice_start_time: document.getElementById('practice-start-time').value,
        practice_end_time: document.getElementById('practice-end-time').value,
        max_patients: parseInt(document.getElementById('max-patients').value),
        services: selectedServices,
    };

    try {
        if (doctorId) {
            await apiRequest(`/admin/doctors/${doctorId}`, 'PUT', doctorData);
            showAlert('Data dokter berhasil diperbarui.');
        } else {
            await apiRequest('/admin/doctors/', 'POST', doctorData);
            showAlert('Dokter baru berhasil ditambahkan.');
        }
        closeDoctorModal();
        fetchAllAdminData();
    } catch(error) {}
}

async function deleteDoctor(doctorId) {
    if (confirm('Apakah Anda yakin ingin menghapus dokter ini?')) {
        try {
            await apiRequest(`/admin/doctors/${doctorId}`, 'DELETE');
            showAlert('Dokter berhasil dihapus.');
            fetchAllAdminData();
        } catch(error) {}
    }
}


// --- PATIENT REGISTRATION ---
function renderRegistrationServiceOptions() {
    const container = document.getElementById('service-options-container');
    const clinicSelect = document.getElementById('clinic-select');
    container.innerHTML = '';
    clinicSelect.innerHTML = '<option value="">-- Pilih Klinik --</option>';

    servicesCache.forEach(service => {
        const option = `
            <label class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50">
                <input type="checkbox" name="registration-services" value="${service.id}" class="form-checkbox h-5 w-5 text-blue-600">
                <span>${service.name}</span>
            </label>
        `;
        container.innerHTML += option;
        
        const selectOption = `<option value="${service.id}">${service.name}</option>`;
        clinicSelect.innerHTML += selectOption;
    });
}

async function handleRegistrationFormSubmit(event) {
    event.preventDefault();
    const selectedServices = Array.from(document.querySelectorAll('input[name="registration-services"]:checked')).map(el => parseInt(el.value));
    
    if (selectedServices.length === 0) {
        showAlert('Silakan pilih setidaknya satu layanan.', 'error');
        return;
    }

    const registrationData = {
        patient_name: document.getElementById('patient-name').value,
        service_ids: selectedServices
    };
    
    try {
        const response = await apiRequest('/register', 'POST', registrationData);
        let ticketInfo = response.tickets.map(t => `${t.service.name}: ${t.queue_number}`).join('\n');
        showAlert(`Pendaftaran berhasil!\n${ticketInfo}`);
        document.getElementById('registration-form').reset();
        fetchDashboardData();
    } catch(error) {}
}


// --- PUBLIC QUEUE VIEW ---
async function fetchQueueForClinic(serviceId) {
    const clinicNameH2 = document.getElementById('queue-clinic-name');
    const waitingList = document.getElementById('waiting-list');
    const servingList = document.getElementById('serving-list');

    if (!serviceId) {
        clinicNameH2.textContent = 'Pilih sebuah klinik';
        waitingList.innerHTML = '';
        servingList.innerHTML = '';
        return;
    }
    
    const service = servicesCache.find(s => s.id == serviceId);
    clinicNameH2.textContent = `Antrean ${service.name}`;

    try {
        const waitingData = await apiRequest(`/queues/${serviceId}?status=waiting`);
        const servingData = await apiRequest(`/queues/${serviceId}?status=serving`);
        
        waitingList.innerHTML = waitingData.length > 0 ? waitingData.map(q => `<li>${q.queue_id_display}</li>`).join('') : '<li class="list-none text-gray-500">Tidak ada antrean.</li>';
        servingList.innerHTML = servingData.length > 0 ? servingData.map(q => `<li>${q.queue_id_display}</li>`).join('') : '<li class="list-none text-gray-500">Tidak ada yang dilayani.</li>';
    } catch (error) {}
}

// --- INITIALIZATION ---
async function fetchAllAdminData() {
    try {
        const [services, doctors] = await Promise.all([
            apiRequest('/admin/services/'),
            apiRequest('/admin/doctors/')
        ]);
        servicesCache = services;
        doctorsCache = doctors;
        renderServiceTable();
        renderDoctorTable();
        renderRegistrationServiceOptions();
    } catch (error) {
        console.error("Gagal memuat data awal:", error);
    }
}


document.addEventListener('DOMContentLoaded', () => {
    // Initial data fetch
    fetchDashboardData();
    fetchAllAdminData();

    // Set up auto-refresh for dashboard
    setInterval(fetchDashboardData, 5000); // Refresh every 5 seconds
    
    // Set up form handlers
    document.getElementById('service-form').addEventListener('submit', handleServiceFormSubmit);
    document.getElementById('doctor-form').addEventListener('submit', handleDoctorFormSubmit);
    document.getElementById('registration-form').addEventListener('submit', handleRegistrationFormSubmit);

});
</script>

</body>
</html>

