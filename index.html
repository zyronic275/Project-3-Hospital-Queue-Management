<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Antrean Rumah Sakit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease-in-out;
        }
        .tab-button.active-tab {
            color: #2563EB; /* text-blue-600 */
            border-color: #2563EB; /* border-blue-600 */
        }
        .toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
            z-index: 50;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- Custom Toast Message -->
<div id="toast" class="toast fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 text-white rounded-xl shadow-2xl transition duration-300 ease-in-out max-w-sm" role="alert">
    <div id="toast-message" class="flex items-center space-x-2">
        <i class="fas fa-info-circle"></i>
        <span>Pesan Notifikasi</span>
    </div>
</div>

<!-- Modal Structure (For CRUD forms and Success Messages) -->
<div id="modal" class="modal-backdrop fixed inset-0 flex items-center justify-center opacity-0 pointer-events-none transition duration-300">
    <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform scale-95 transition duration-300">
        <!-- Content will be injected here -->
    </div>
</div>

<div class="container mx-auto p-4 md:p-8">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center">
            <i class="fas fa-hospital text-blue-600 mr-3"></i>
            Sistem Antrean Rumah Sakit
        </h1>
        <p class="text-gray-500">Dasbor Administrasi dan Pendaftaran Publik</p>
    </header>

    <!-- Tab Navigation -->
    <nav class="border-b border-gray-200 mb-8">
        <div class="-mb-px flex space-x-8" id="tab-nav">
            <button class="tab-button py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent active-tab" onclick="switchView('public-view', this)">Pendaftaran & Antrean Publik</button>
            <button class="tab-button py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" onclick="switchView('admin-dashboard', this)">Admin: Dashboard Monitoring</button>
            <button class="tab-button py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" onclick="switchView('admin-services', this)">Admin: Master Layanan (Klinik)</button>
            <button class="tab-button py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" onclick="switchView('admin-doctors', this)">Admin: Master Dokter</button>
        </div>
    </nav>

    <!-- VIEWS CONTAINER -->
    <div id="views-container">

        <!-- 1. PUBLIC VIEW (Active by default) -->
        <div id="public-view" class="view active grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Registration Card -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-user-plus text-blue-500 mr-2"></i> Pendaftaran Pasien Baru
                </h2>
                <form id="registration-form" class="space-y-4">
                    <div>
                        <label for="patient-name" class="block text-sm font-medium text-gray-600">Nama Pasien</label>
                        <input type="text" id="patient-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="date-of-birth" class="block text-sm font-medium text-gray-600">Tanggal Lahir</label>
                        <input type="date" id="date-of-birth" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div id="registration-service-options" class="space-y-3 p-3 border border-blue-200 rounded-lg bg-blue-50">
                        <label class="block text-sm font-medium text-blue-700">Pilih Layanan (Bisa lebih dari satu)</label>
                        <!-- Checkboxes will be rendered here -->
                    </div>
                    
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        Ambil Nomor Antrean <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </form>

                <!-- Registration Success Message & QR Code -->
                <div id="registration-success-message" class="hidden text-center p-6 bg-green-50 rounded-xl mt-4 border border-green-200">
                    <i class="fas fa-check-circle text-green-600 text-4xl mb-3"></i>
                    <h3 class="text-xl font-bold text-green-700 mb-2">Pendaftaran Berhasil!</h3>
                    <p id="success-patient-name" class="text-gray-600 mb-4 font-medium"></p>
                    <div id="success-tickets-info" class="space-y-4 text-left">
                        <!-- Ticket info and QR Codes will be injected here -->
                    </div>
                    <button onclick="resetRegistrationForm()" class="mt-6 py-2 px-4 text-sm font-medium rounded-lg text-green-700 bg-green-200 hover:bg-green-300 transition duration-150">
                        Lakukan Pendaftaran Lain
                    </button>
                </div>
            </div>

            <!-- Queue Status Card -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-list-ol text-red-500 mr-2"></i> Status Antrean Aktif Hari Ini
                </h2>
                <div class="mb-4">
                    <label for="clinic-select" class="block text-sm font-medium text-gray-600">Pilih Klinik/Layanan</label>
                    <select id="clinic-select" class="mt-1 block w-full md:w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" onchange="fetchQueueForClinic(this.value)">
                        <option value="">-- Pilih Klinik --</option>
                    </select>
                </div>
                
                <div id="queue-list-container">
                    <p class="text-gray-500 text-center py-8" id="queue-placeholder">Silakan pilih klinik untuk melihat antrean.</p>
                </div>

                <!-- Admin/Scanner Tool -->
                <div class="mt-8 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Simulasi Update Status Antrean (Admin/Scanner)</h3>
                    <form id="scanner-form" class="flex space-x-2">
                        <input type="text" id="scan-id" placeholder="Masukkan Queue ID Display (mis: UMUM-D001-0001)" required class="flex-grow rounded-lg border-gray-300 shadow-sm p-2 border">
                        <select id="new-status" required class="rounded-lg border-gray-300 shadow-sm p-2 border">
                            <option value="sedang dilayani">Sedang Dilayani</option>
                            <option value="selesai">Selesai</option>
                            <option value="tidak hadir">Tidak Hadir</option>
                        </select>
                        <button type="submit" class="py-2 px-4 rounded-lg bg-red-500 text-white hover:bg-red-600 transition duration-150">Update Status</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 2. ADMIN DASHBOARD VIEW -->
        <div id="admin-dashboard" class="view">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Dashboard Monitoring Kepadatan</h2>
            <div id="dashboard-data" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="p-6 text-center bg-gray-200 rounded-xl shadow-inner text-gray-600">Memuat data...</div>
            </div>
        </div>

        <!-- 3. ADMIN SERVICES VIEW (CRUD) -->
        <div id="admin-services" class="view">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Master Data Layanan (Klinik)</h2>
            <button onclick="openModal('service', null)" class="mb-4 py-2 px-4 rounded-lg bg-green-600 text-white hover:bg-green-700 transition duration-150">
                <i class="fas fa-plus mr-1"></i> Tambah Layanan Baru
            </button>
            <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Layanan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prefix (Kode)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="service-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 4. ADMIN DOCTORS VIEW (CRUD) -->
        <div id="admin-doctors" class="view">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Master Data Dokter</h2>
            <button onclick="openModal('doctor', null)" class="mb-4 py-2 px-4 rounded-lg bg-green-600 text-white hover:bg-green-700 transition duration-150">
                <i class="fas fa-user-md mr-1"></i> Tambah Dokter Baru
            </button>
            <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Dokter (Kode)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jadwal (Maks Pasien)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Layanan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="doctor-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    const API_BASE_URL = window.location.origin;

    let servicesCache = [];
    let doctorsCache = [];

    // --- UTILITY FUNCTIONS ---

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        toastMessage.innerHTML = `<i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i> <span>${message}</span>`;
        toast.classList.toggle('bg-gray-800', !isError);
        toast.classList.toggle('bg-red-600', isError);
        
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function switchView(viewId, button) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');

        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab'));
        if (button) button.classList.add('active-tab');
        
        // Load data on tab switch if needed
        if (viewId === 'admin-dashboard') fetchDashboardData();
        if (viewId === 'admin-services' || viewId === 'admin-doctors') fetchAllAdminData();
    }
    
    // --- API CALL HANDLER ---

    async function apiRequest(endpoint, method = 'GET', data = null) {
        const url = `${API_BASE_URL}${endpoint}`;
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
        };

        if (data) {
            options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(url, options);
            const contentType = response.headers.get("content-type");
            
            if (!response.ok) {
                let errorData = { detail: `HTTP Error: ${response.status} ${response.statusText}` };
                
                if (contentType && contentType.includes("application/json")) {
                    errorData = await response.json();
                }
                
                const errorMessage = errorData.detail || errorData.message || `Operasi gagal (${response.status})`;
                showToast(errorMessage, true);
                throw new Error(errorMessage);
            }
            
            if (contentType && contentType.includes("application/json")) {
                return await response.json();
            } else if (response.status === 204) {
                return null;
            } else {
                return await response.text();
            }
            
        } catch (error) {
            console.error('API Request Error:', error);
            // Toast already shown in the !response.ok block
            throw error;
        }
    }
    
    // --- MODAL & FORM HANDLERS ---

    function closeModal() {
        const modal = document.getElementById('modal');
        modal.classList.remove('opacity-100', 'pointer-events-auto');
        modal.classList.add('opacity-0', 'pointer-events-none');
        document.getElementById('modal-content').innerHTML = ''; // Clear content
    }

    function openModal(type, data = null) {
        const modal = document.getElementById('modal');
        const content = document.getElementById('modal-content');
        let formHTML = '';
        let title = '';

        if (type === 'service') {
            title = data ? 'Edit Layanan' : 'Tambah Layanan Baru';
            formHTML = `
                <form id="service-form" onsubmit="handleServiceFormSubmit(event, ${data ? data.id : 'null'})" class="space-y-4">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3>
                    <div>
                        <label for="service-name" class="block text-sm font-medium text-gray-700">Nama Layanan (Klinik)</label>
                        <input type="text" id="service-name" name="name" value="${data ? data.name : ''}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="service-prefix" class="block text-sm font-medium text-gray-700">Prefix Kode Antrean (Max 5 Karakter, ex: UMUM)</label>
                        <input type="text" id="service-prefix" name="prefix" value="${data ? data.prefix : ''}" maxlength="5" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal()" class="py-2 px-4 rounded-lg text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-150">Batal</button>
                        <button type="submit" class="py-2 px-4 rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">Simpan</button>
                    </div>
                </form>
            `;
        } else if (type === 'doctor') {
            title = data ? 'Edit Data Dokter' : 'Tambah Dokter Baru';
            const serviceOptions = servicesCache.map(s => `
                <div class="flex items-center">
                    <input type="checkbox" id="service-${s.id}" name="services" value="${s.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded" ${data && data.services.some(ds => ds.id === s.id) ? 'checked' : ''}>
                    <label for="service-${s.id}" class="ml-2 text-sm text-gray-700">${s.name}</label>
                </div>
            `).join('');

            formHTML = `
                <form id="doctor-form" onsubmit="handleDoctorFormSubmit(event, ${data ? data.id : 'null'})" class="space-y-4">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3>
                    <div>
                        <label for="doctor-name" class="block text-sm font-medium text-gray-700">Nama Dokter</label>
                        <input type="text" id="doctor-name" name="name" value="${data ? data.name : ''}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="doctor-code" class="block text-sm font-medium text-gray-700">Kode Dokter (ex: D001)</label>
                            <input type="text" id="doctor-code" name="doctor_code" value="${data ? data.doctor_code : ''}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="max-patients" class="block text-sm font-medium text-gray-700">Kuota Maks Pasien/Hari</label>
                            <input type="number" id="max-patients" name="max_patients" value="${data ? data.max_patients : 20}" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="start-time" class="block text-sm font-medium text-gray-700">Jam Mulai Praktik</label>
                            <input type="time" id="start-time" name="practice_start_time" value="${data ? data.practice_start_time.substring(0, 5) : '08:00'}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="end-time" class="block text-sm font-medium text-gray-700">Jam Selesai Praktik</label>
                            <input type="time" id="end-time" name="practice_end_time" value="${data ? data.practice_end_time.substring(0, 5) : '17:00'}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Layanan yang Ditangani</label>
                        <div class="flex flex-wrap gap-4 p-3 border rounded-lg bg-gray-50">${serviceOptions}</div>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal()" class="py-2 px-4 rounded-lg text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-150">Batal</button>
                        <button type="submit" class="py-2 px-4 rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">Simpan</button>
                    </div>
                </form>
            `;
        }
        
        content.innerHTML = formHTML;
        modal.classList.add('opacity-100', 'pointer-events-auto');
        modal.classList.remove('opacity-0', 'pointer-events-none');
    }

    // --- ADMIN CRUD LOGIC ---

    async function fetchAllAdminData() {
        try {
            const [services, doctors] = await Promise.all([apiRequest('/admin/services/'), apiRequest('/admin/doctors/')]);
            servicesCache = services;
            doctorsCache = doctors;
            
            renderServiceTable();
            renderDoctorTable();
            renderRegistrationServiceOptions();
            
            const clinicSelect = document.getElementById('clinic-select');
            clinicSelect.innerHTML = '<option value="">-- Pilih Klinik --</option>';
            servicesCache.forEach(s => clinicSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
        } catch (error) {
            // Error already handled by apiRequest
        }
    }

    async function handleServiceFormSubmit(event, id) {
        event.preventDefault();
        const form = event.target;
        const data = {
            name: form['service-name'].value,
            prefix: form['service-prefix'].value.toUpperCase(),
        };

        try {
            if (id) {
                await apiRequest(`/admin/services/${id}`, 'PUT', data);
                showToast('Layanan berhasil diperbarui!');
            } else {
                await apiRequest('/admin/services/', 'POST', data);
                showToast('Layanan berhasil ditambahkan!');
            }
            closeModal();
            fetchAllAdminData();
        } catch (error) {
            // Error already handled
        }
    }

    async function deleteService(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus Layanan ini?')) return;
        try {
            await apiRequest(`/admin/services/${id}`, 'DELETE');
            showToast('Layanan berhasil dihapus!', false);
            fetchAllAdminData();
        } catch (error) {
            // Error already handled
        }
    }

    function renderServiceTable() {
        const tbody = document.getElementById('service-table-body');
        tbody.innerHTML = '';
        if (servicesCache.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada data layanan.</td></tr>';
            return;
        }

        servicesCache.forEach(service => {
            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${service.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${service.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${service.prefix}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button onclick="openModal('service', ${JSON.stringify(service).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deleteService(${service.id})" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i> Hapus</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    async function handleDoctorFormSubmit(event, id) {
        event.preventDefault();
        const form = event.target;
        const serviceIds = Array.from(form.elements.services)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => parseInt(checkbox.value));
        
        const data = {
            doctor_code: form['doctor-code'].value,
            name: form['doctor-name'].value,
            practice_start_time: form['start-time'].value + ':00',
            practice_end_time: form['end-time'].value + ':00',
            max_patients: parseInt(form['max-patients'].value),
            services: serviceIds,
        };

        try {
            if (id) {
                await apiRequest(`/admin/doctors/${id}`, 'PUT', data);
                showToast('Data Dokter berhasil diperbarui!');
            } else {
                await apiRequest('/admin/doctors/', 'POST', data);
                showToast('Data Dokter berhasil ditambahkan!');
            }
            closeModal();
            fetchAllAdminData();
        } catch (error) {
            // Error already handled
        }
    }

    async function deleteDoctor(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus Dokter ini?')) return;
        try {
            await apiRequest(`/admin/doctors/${id}`, 'DELETE');
            showToast('Data Dokter berhasil dihapus!', false);
            fetchAllAdminData();
        } catch (error) {
            // Error already handled
        }
    }

    function renderDoctorTable() {
        const tbody = document.getElementById('doctor-table-body');
        tbody.innerHTML = '';
        if (doctorsCache.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada data dokter.</td></tr>';
            return;
        }

        doctorsCache.forEach(doctor => {
            const serviceNames = doctor.services.map(s => `<span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium mr-1 px-2.5 py-0.5 rounded-full">${s.name}</span>`).join('');
            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${doctor.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${doctor.name} <span class="text-xs text-gray-500">(${doctor.doctor_code})</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${doctor.practice_start_time.substring(0, 5)} - ${doctor.practice_end_time.substring(0, 5)} (${doctor.max_patients} pasien)</td>
                    <td class="px-6 py-4 whitespace-wrap text-sm text-gray-700">${serviceNames}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button onclick="openModal('doctor', ${JSON.stringify(doctor).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deleteDoctor(${doctor.id})" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i> Hapus</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // --- PUBLIC REGISTRATION LOGIC ---

    function renderRegistrationServiceOptions() {
        const container = document.getElementById('registration-service-options');
        container.innerHTML = '<label class="block text-sm font-medium text-blue-700 mb-2">Pilih Layanan (Bisa lebih dari satu)</label>';
        
        if (servicesCache.length === 0) {
            container.innerHTML += '<p class="text-sm text-red-500">Tidak ada layanan tersedia. Hubungi admin.</p>';
            return;
        }

        servicesCache.forEach(s => {
            container.innerHTML += `
                <div class="flex items-center">
                    <input type="checkbox" id="reg-service-${s.id}" name="reg-service" value="${s.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="reg-service-${s.id}" class="ml-3 text-sm font-medium text-gray-700">${s.name}</label>
                </div>
            `;
        });
    }

    function resetRegistrationForm() {
        document.getElementById('registration-form').reset();
        document.getElementById('registration-form').classList.remove('hidden');
        document.getElementById('registration-success-message').classList.add('hidden');
    }

    async function handleRegistrationFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        
        const serviceIds = Array.from(form.elements['reg-service'])
            .filter(checkbox => checkbox.checked)
            .map(checkbox => parseInt(checkbox.value));

        if (serviceIds.length === 0) {
            showToast("Harap pilih minimal satu layanan.", true);
            return;
        }

        const data = {
            patient_name: form['patient-name'].value,
            date_of_birth: form['date-of-birth'].value,
            service_ids: serviceIds,
            // doctor_id diabaikan, backend akan memilih otomatis
        };

        try {
            const response = await apiRequest('/registration', 'POST', data);
            showToast('Pendaftaran antrean berhasil!', false);
            
            // Render success message and QR code
            const successDiv = document.getElementById('registration-success-message');
            document.getElementById('success-patient-name').textContent = `Pasien: ${response.patient.name}`;
            
            const ticketsInfo = document.getElementById('success-tickets-info');
            ticketsInfo.innerHTML = response.tickets.map(ticket => `
                <div class="p-4 border border-green-300 rounded-lg bg-white shadow-md flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4">
                    <div class="flex-shrink-0 text-center">
                        <img src="data:image/png;base64,${ticket.qr_code_base64}" alt="QR Code untuk ${ticket.queue_number}" class="w-24 h-24 mx-auto border-4 border-gray-100 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">Scan untuk update status</p>
                    </div>
                    <div class="flex-grow text-center md:text-left">
                        <p class="text-sm font-semibold text-gray-500">Nomor Antrean Anda:</p>
                        <p class="text-4xl font-extrabold text-blue-600 mb-1">${ticket.queue_number}</p>
                        <p class="text-lg font-medium">Layanan: <span class="text-green-700">${ticket.service.name}</span></p>
                        <p class="text-sm text-gray-600">Dokter: ${ticket.doctor.name}</p>
                    </div>
                </div>
            `).join('');

            form.classList.add('hidden');
            successDiv.classList.remove('hidden');
            
            // Refresh queue list if a clinic is selected
            const selectedClinicId = document.getElementById('clinic-select').value;
            if (selectedClinicId) fetchQueueForClinic(selectedClinicId);

        } catch (error) {
            // Error already handled by apiRequest
        }
    }

    // --- PUBLIC QUEUE VIEW LOGIC ---

    async function fetchQueueForClinic(serviceId) {
        const listContainer = document.getElementById('queue-list-container');
        const placeholder = document.getElementById('queue-placeholder');
        
        if (!serviceId) {
            placeholder.classList.remove('hidden');
            listContainer.innerHTML = '';
            listContainer.appendChild(placeholder);
            return;
        }
        
        placeholder.classList.add('hidden');
        listContainer.innerHTML = '<p class="text-center py-4 text-gray-500">Memuat antrean...</p>';

        try {
            const queues = await apiRequest(`/queue/by-clinic/${serviceId}`);
            renderQueueList(queues);
        } catch (error) {
            listContainer.innerHTML = '<p class="text-center py-4 text-red-500">Gagal memuat data antrean.</p>';
        }
    }

    function renderQueueList(queues) {
        const listContainer = document.getElementById('queue-list-container');
        const selectedClinicId = document.getElementById('clinic-select').value;
        const selectedService = servicesCache.find(s => s.id == selectedClinicId);
        
        if (!selectedService) {
            listContainer.innerHTML = '<p class="text-center py-4 text-gray-500">Layanan tidak ditemukan.</p>';
            return;
        }

        if (queues.length === 0) {
            listContainer.innerHTML = `<p class="text-center py-8 text-gray-500">Tidak ada antrean aktif untuk ${selectedService.name} hari ini.</p>`;
            return;
        }

        const queueHTML = queues.map(q => {
            const statusClass = q.status === 'sedang dilayani' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700';
            const statusIcon = q.status === 'sedang dilayani' ? 'fa-spinner fa-spin' : 'fa-clock';
            const patientName = 'Pasien ID ' + q.patient_id; // Nama pasien tidak dikembalikan dari endpoint ini

            return `
                <div class="p-4 mb-3 rounded-lg shadow-sm border border-gray-100 flex items-center justify-between ${q.status === 'sedang dilayani' ? 'bg-yellow-50 ring-2 ring-yellow-300' : 'bg-white'}">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 flex items-center justify-center rounded-full ${statusClass} font-extrabold text-2xl shadow-md">
                            ${q.queue_number}
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Antrean: ${q.queue_id_display}</p>
                            <p class="text-lg font-bold text-gray-800">${patientName}</p>
                            <p class="text-xs text-gray-500">Didaftar: ${new Date(q.registration_time).toLocaleTimeString()}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas ${statusIcon} text-lg ${q.status === 'sedang dilayani' ? 'text-yellow-700' : 'text-gray-500'}"></i>
                        <span class="font-medium capitalize text-sm ${q.status === 'sedang dilayani' ? 'text-yellow-700' : 'text-gray-600'}">${q.status}</span>
                    </div>
                </div>
            `;
        }).join('');

        listContainer.innerHTML = queueHTML;
    }

    // --- ADMIN MONITORING LOGIC ---

    async function fetchDashboardData() {
        try {
            const dashboard = await apiRequest('/admin/dashboard');
            renderDashboard(dashboard);
        } catch (error) {
            document.getElementById('dashboard-data').innerHTML = '<p class="text-red-500 text-center col-span-full py-8">Gagal memuat data dashboard.</p>';
        }
    }

    function renderDashboard(data) {
        const container = document.getElementById('dashboard-data');
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">Belum ada layanan terdaftar.</p>';
            return;
        }

        data.forEach(clinic => {
            const densityColor = clinic.density_percentage > 75 ? 'bg-red-500' : 
                                 clinic.density_percentage > 50 ? 'bg-yellow-500' : 'bg-green-500';
            const card = `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-gray-800">${clinic.service_name}</h3>
                        <div class="text-xs font-semibold text-white px-3 py-1 rounded-full ${densityColor}">
                            ${clinic.density_percentage}% Penuh
                        </div>
                    </div>
                    <p class="text-4xl font-extrabold text-gray-900 mb-4">${clinic.patients_waiting + clinic.patients_serving}</p>
                    <div class="space-y-1 text-sm text-gray-600">
                        <p><i class="fas fa-clock text-blue-500 mr-2"></i> Menunggu: <span class="font-semibold">${clinic.patients_waiting}</span> pasien</p>
                        <p><i class="fas fa-user-md text-yellow-500 mr-2"></i> Dilayani: <span class="font-semibold">${clinic.patients_serving}</span> pasien</p>
                        <p><i class="fas fa-users text-gray-500 mr-2"></i> Total Hari Ini: <span class="font-semibold">${clinic.total_patients_today}</span> pasien</p>
                        <p><i class="fas fa-sort-up text-red-500 mr-2"></i> Maksimal: ${clinic.max_patients_total} pasien</p>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }

    // --- SCANNER/ADMIN UPDATE FORM LOGIC ---

    async function handleScannerFormSubmit(event) {
        event.preventDefault();
        const scanId = document.getElementById('scan-id').value.trim();
        const newStatus = document.getElementById('new-status').value;

        try {
            const response = await apiRequest(`/admin/queue/update-status/${scanId}`, 'PUT', { status: newStatus });
            showToast(`Status antrean ${response.queue_id_display} berhasil diubah menjadi: ${newStatus.toUpperCase()}`, false);
            
            // Refresh queue list if a clinic is selected
            const selectedClinicId = document.getElementById('clinic-select').value;
            if (selectedClinicId) fetchQueueForClinic(selectedClinicId);

        } catch (error) {
            // Error already handled
        }
    }


    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchAllAdminData();
        fetchDashboardData();
        
        // Refresh dashboard setiap 5 detik
        setInterval(fetchDashboardData, 5000); 
        // Refresh queue publik setiap 5 detik jika tab aktif
        setInterval(() => {
            if (document.getElementById('public-view').classList.contains('active')) {
                const selectedClinicId = document.getElementById('clinic-select').value;
                if (selectedClinicId) fetchQueueForClinic(selectedClinicId);
            }
        }, 5000);
        
        // Listener for Scanner/Admin form
        document.getElementById('scanner-form').addEventListener('submit', handleScannerFormSubmit);
        
        // Listeners for initial forms (needed for form inside view, not modal)
        // Since CRUD forms are now inside modal, we only need to listen for public registration form here
        document.getElementById('registration-form').addEventListener('submit', handleRegistrationFormSubmit);
    });
</script>
</body>
</html>