<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Antrean Rumah Sakit (MOCK DATA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script> 
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease-in-out;
        }
        .tab-button.active-tab {
            color: #2563EB; /* text-blue-600 */
            border-color: #2563EB; /* border-blue-600 */
        }
        .toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .card-hover:hover {
             transform: translateY(-5px);
             box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 lg:p-6">
        <header class="bg-white shadow rounded-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Dasbor Manajemen Antrean (MOCK DATA)</h1>
            <p class="text-gray-600">Pusat kontrol untuk pendaftaran, administrasi, dan monitoring.</p>
        </header>

        <div class="mb-4 border-b border-gray-200 bg-white rounded-t-lg">
            <nav class="flex -mb-px" aria-label="Tabs">
                <button onclick="switchView('dashboard')" class="tab-button active-tab whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm" data-view="dashboard">
                    <i class="fas fa-tachometer-alt mr-2"></i>Monitoring
                </button>
                <button onclick="switchView('admin')" class="tab-button whitespace-nowrap py-4 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-view="admin">
                    <i class="fas fa-user-shield mr-2"></i>Manajemen Admin
                </button>
                <button onclick="switchView('registration')" class="tab-button whitespace-nowrap py-4 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-view="registration">
                    <i class="fas fa-qrcode mr-2"></i>Daftar & QR Code
                </button>
                <button onclick="switchView('public')" class="tab-button whitespace-nowrap py-4 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-view="public">
                    <i class="fas fa-tv mr-2"></i>Layar Antrean Publik
                </button>
            </nav>
        </div>

        <main>
            <div id="dashboard-view" class="view active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="dashboard-grid">
                    </div>
            </div>

            <div id="admin-view" class="view">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-700">Manajemen Layanan (Klinik)</h2>
                            <button onclick="openServiceModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow"><i class="fas fa-plus mr-2"></i>Tambah</button>
                        </div>
                        <div class="flex text-xs font-medium text-gray-500 uppercase px-4 py-2 bg-gray-50 rounded-t-lg">
                            <div class="flex-1">Nama & Lokasi</div>
                            <div class="w-24 text-right">Aksi</div>
                        </div>
                        <div id="service-table-body" class="divide-y divide-gray-200">
                            </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-700">Manajemen Dokter</h2>
                            <button onclick="openDoctorModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow"><i class="fas fa-plus mr-2"></i>Tambah</button>
                        </div>
                       <div class="flex text-xs font-medium text-gray-500 uppercase px-4 py-2 bg-gray-50 rounded-t-lg">
                            <div class="flex-1">Nama & Spesialisasi</div>
                            <div class="w-28 text-center">Klinik</div>
                            <div class="w-24 text-right">Aksi</div>
                        </div>
                        <div id="doctor-table-body" class="divide-y divide-gray-200">
                           </div>
                    </div>
                </div>
            </div>

            <div id="registration-view" class="view">
                <div class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">Form Pendaftaran Kunjungan Baru</h2>
                    <form id="registration-form">
                        <div class="mb-4 border-b pb-4">
                             <h3 class="text-lg font-semibold mb-2 text-blue-600">Data Pasien (Pasien baru akan otomatis dibuat)</h3>
                            <div class="mb-4">
                                <label for="patient-name" class="block text-gray-700 text-sm font-bold mb-2">1. Nama Pasien</label>
                                <input type="text" id="patient-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div class="mb-4">
                                <label for="patient-nik" class="block text-gray-700 text-sm font-bold mb-2">2. NIK (KTP - Harus Unik)</label>
                                <input type="text" id="patient-nik" maxlength="16" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div class="mb-4 flex space-x-4">
                                <div class="w-1/2">
                                    <label for="patient-dob" class="block text-gray-700 text-sm font-bold mb-2">3. Tanggal Lahir</label>
                                    <input type="date" id="patient-dob" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                </div>
                                <div class="w-1/2">
                                    <label for="patient-gender" class="block text-gray-700 text-sm font-bold mb-2">4. Jenis Kelamin</label>
                                    <select id="patient-gender" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none focus:shadow-outline" required>
                                        <option value="Male">Laki-laki</option>
                                        <option value="Female">Perempuan</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="patient-phone" class="block text-gray-700 text-sm font-bold mb-2">5. No. Telepon (Opsional)</label>
                                <input type="text" id="patient-phone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">6. Pilih Layanan (Klinik)</label>
                            <div id="service-options-container" class="space-y-2">
                                </div>
                        </div>
                        <div id="doctor-choice-container" class="mb-6 hidden">
                            <label class="block text-gray-700 text-sm font-bold mb-2">7. Pilih Dokter</label>
                            <div id="doctor-options-container" class="space-y-2 p-3 bg-gray-50 rounded-lg">
                                </div>
                        </div>
                        <div class="flex items-center justify-center mt-6">
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow">
                                <i class="fas fa-paper-plane mr-2"></i>Dapatkan Nomor Antrean
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="public-view" class="view">
                <div class="mb-4 bg-white p-4 rounded-lg shadow">
                    <label for="clinic-select" class="block text-gray-700 text-sm font-bold mb-2">Pilih Klinik untuk Ditampilkan:</label>
                    <select id="clinic-select" onchange="fetchQueueForClinic(this.value)" class="shadow border rounded w-full md:w-1/3 py-2 px-3 text-gray-700 focus:outline-none focus:shadow-outline">
                        <option value="">-- Pilih Klinik --</option>
                    </select>
                </div>
                <div id="queue-display" class="bg-white p-6 rounded-lg shadow">
                    <div class="text-center mb-4">
                        <h2 id="queue-clinic-name" class="text-2xl font-bold">Pilih sebuah klinik</h2>
                        <p id="queue-date" class="text-gray-600"></p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Antrean</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Daftar</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="queue-table-body" class="divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="service-modal" class="modal-backdrop hidden fixed inset-0 z-50 flex justify-center items-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h2 id="service-modal-title" class="text-2xl font-bold mb-4"></h2><form id="service-form"><input type="hidden" id="service-id"><div class="mb-4"><label for="service-name" class="block text-gray-700 text-sm font-bold mb-2">Nama Layanan (Klinik)</label><input type="text" id="service-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="service-location" class="block text-gray-700 text-sm font-bold mb-2">Lokasi</label><input type="text" id="service-location" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"></div><div class="flex justify-end space-x-4"><button type="button" onclick="closeServiceModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Batal</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Simpan</button></div></form></div></div>
    <div id="doctor-modal" class="modal-backdrop hidden fixed inset-0 z-50 flex justify-center items-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6"><h2 id="doctor-modal-title" class="text-2xl font-bold mb-4"></h2><form id="doctor-form"><input type="hidden" id="doctor-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="mb-4"><label for="doctor-name" class="block text-gray-700 text-sm font-bold mb-2">Nama Dokter</label><input type="text" id="doctor-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required></div><div class="mb-4"><label for="doctor-specialization" class="block text-gray-700 text-sm font-bold mb-2">Spesialisasi</label><input type="text" id="doctor-specialization" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required></div><div class="mb-4 col-span-2"><label for="doctor-clinic-id" class="block text-gray-700 text-sm font-bold mb-2">Klinik yang Ditangani</label><select id="doctor-clinic-id" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none focus:shadow-outline" required></select></div></div><div class="flex justify-end space-x-4"><button type="button" onclick="closeDoctorModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Batal</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Simpan</button></div></form></div></div>
    <div id="confirm-modal" class="modal-backdrop hidden fixed inset-0 z-50 flex justify-center items-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h3 class="text-lg font-bold" id="confirm-title"></h3><p class="my-4" id="confirm-message"></p><div class="flex justify-center space-x-4"><button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Batal</button><button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Hapus</button></div></div></div>
    
    <div id="qrcode-result-modal" class="modal-backdrop hidden fixed inset-0 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 transform transition-all overflow-hidden">
            <h2 class="text-3xl font-bold text-green-600 mb-2 text-center"><i class="fas fa-check-circle mr-2"></i>Pendaftaran Berhasil!</h2>
            <p class="text-center text-lg mb-6 text-gray-700">Nomor Antrean Anda Telah Tercetak.</p>

            <div class="border border-dashed border-gray-300 p-6 rounded-lg bg-gray-50 mb-6">
                <div class="text-center mb-4">
                    <p class="text-sm text-gray-500 font-medium">NOMOR ANTRIAN</p>
                    <h1 id="qr-queue-number" class="text-7xl font-extrabold text-blue-600">Q001</h1>
                </div>
                <div id="qrcode-container" class="mx-auto w-48 h-48 p-2 bg-white border border-gray-200">
                    </div>
                <p class="text-center text-sm mt-4 text-gray-600">Tunjukkan kode ini saat dipanggil atau simpan gambar ini.</p>
            </div>

            <div class="text-sm space-y-2 text-gray-700">
                <p><strong>Pasien:</strong> <span id="qr-patient-name"></span></p>
                <p><strong>Dokter Tujuan:</strong> <span id="qr-doctor-name"></span></p>
                <p><strong>Tanggal Kunjungan:</strong> <span id="qr-visit-date"></span></p>
            </div>

            <div class="flex justify-center mt-6">
                <button onclick="document.getElementById('qrcode-result-modal').classList.add('hidden');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow">
                    Tutup
                </button>
            </div>
        </div>
    </div>


    <div id="toast" class="toast hidden fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg max-w-sm"></div>

<script>
// --- MOCK DATA STATE (MENGGANTIKAN DATABASE) ---
let nextServiceId = 3;
let nextDoctorId = 5;
let nextVisitId = 6;
let nextPatientId = 4;
let nextQueueNumber = 4;

let mockServices = [ // Clinics
    { id: 1, name: 'Poli Umum', location: 'Lantai 1, Blok A' },
    { id: 2, name: 'Poli Gigi', location: 'Lantai 2, Blok B' }
];

let mockDoctors = [
    { id: 1, name: 'Andi Pratama', specialization: 'Umum', clinic_id: 1, is_active: true },
    { id: 2, name: 'Budi Santoso', specialization: 'Bedah Minor', clinic_id: 1, is_active: true },
    { id: 3, name: 'Citra Dewi', specialization: 'Ortodonti', clinic_id: 2, is_active: true },
    { id: 4, name: 'Dedi Kusuma', specialization: 'Umum', clinic_id: 1, is_active: true }
];

let mockPatients = [
    { id: 1, name: 'Joko Susilo', nik: '1234567890123456', dob: '1990-01-01', gender: 'Male', phone: '081111' },
    { id: 2, name: 'Siti Aisyah', nik: '6543210987654321', dob: '1985-05-15', gender: 'Female', phone: '082222' },
    { id: 3, name: 'Bambang Irawan', nik: '1000000000000000', dob: '2000-10-20', gender: 'Male', phone: '083333' }
];

// Status: waiting, in_progress, finished, cancelled
let mockVisits = [
    { id: 1, patient_id: 1, doctor_id: 1, visit_date: new Date().toISOString().split('T')[0], queue_number: 'A001', status: 'finished', registered_at: '08:00' },
    { id: 2, patient_id: 2, doctor_id: 1, visit_date: new Date().toISOString().split('T')[0], queue_number: 'A002', status: 'in_progress', registered_at: '08:15' },
    { id: 3, patient_id: 3, doctor_id: 1, visit_date: new Date().toISOString().split('T')[0], queue_number: 'A003', status: 'waiting', registered_at: '08:30' },
    { id: 4, patient_id: 1, doctor_id: 3, visit_date: new Date().toISOString().split('T')[0], queue_number: 'B001', status: 'waiting', registered_at: '09:00' },
    { id: 5, patient_id: 2, doctor_id: 3, visit_date: new Date().toISOString().split('T')[0], queue_number: 'B002', status: 'waiting', registered_at: '09:15' }
];


// --- MOCK API REQUEST (MENGGANTIKAN FETCH ASLI) ---
// Note: Simulasi ini mengasumsikan ID di mock data adalah angka.
async function mockApiRequest(endpoint, method = 'GET', body = null) {
    // Simulasi jeda (delay) jaringan 100ms
    await new Promise(resolve => setTimeout(resolve, 100)); 

    // Helper untuk mencari objek
    const findById = (array, id) => array.find(item => item.id == id);
    const getIndexById = (array, id) => array.findIndex(item => item.id == id);

    try {
        // Services/Clinics
        if (endpoint.startsWith('/clinics')) {
            const id = endpoint.split('/')[2];
            if (method === 'GET' && !id) return [...mockServices];
            if (method === 'POST') {
                const newService = { id: nextServiceId++, name: body.name, location: body.location || null };
                mockServices.push(newService);
                return newService;
            }
            if (method === 'PUT' && id) {
                const index = getIndexById(mockServices, id);
                if (index === -1) throw new Error('Klinik tidak ditemukan.');
                mockServices[index] = { ...mockServices[index], ...body, id: parseInt(id) };
                return mockServices[index];
            }
            if (method === 'DELETE' && id) {
                mockServices = mockServices.filter(s => s.id != id);
                mockDoctors.filter(d => d.clinic_id == id).forEach(d => d.clinic_id = null);
                return null; 
            }
        }
        
        // Doctors
        if (endpoint.startsWith('/doctors')) {
            const id = endpoint.split('/')[2];
            if (method === 'GET' && !id) return [...mockDoctors];
            if (method === 'POST') {
                const newDoctor = { id: nextDoctorId++, name: body.name, specialization: body.specialization || 'Umum', clinic_id: body.clinic_id, is_active: true };
                mockDoctors.push(newDoctor);
                return newDoctor;
            }
            if (method === 'PUT' && id) {
                const index = getIndexById(mockDoctors, id);
                if (index === -1) throw new Error('Dokter tidak ditemukan.');
                mockDoctors[index] = { ...mockDoctors[index], ...body, id: parseInt(id) };
                return mockDoctors[index];
            }
            if (method === 'DELETE' && id) {
                mockDoctors = mockDoctors.filter(d => d.id != id);
                return null;
            }
        }
        
        // Visits/Queue
        if (endpoint.startsWith('/visits')) {
            if (method === 'GET') {
                // Simulasi filter date_filter (mengambil semua kunjungan yang tanggalnya sama dengan today)
                const today = new Date().toISOString().split('T')[0];
                return mockVisits.filter(v => v.visit_date === today);
            }
            if (method === 'POST' && endpoint.endsWith('/register')) {
                // Simulasi registrasi pasien & kunjungan
                const now = new Date();
                const clinicId = findById(mockDoctors, body.doctor_id)?.clinic_id;
                const clinicPrefix = findById(mockServices, clinicId)?.name[0].toUpperCase() || 'Q';

                // Simulasi cari pasien atau buat baru (logika NIK unik)
                let patient = mockPatients.find(p => p.nik === body.patient_nik);
                if (!patient) {
                    patient = { 
                        id: nextPatientId++, 
                        name: body.patient_name, 
                        nik: body.patient_nik, 
                        dob: body.patient_dob, 
                        gender: body.patient_gender,
                        phone: body.patient_phone || null
                    };
                    mockPatients.push(patient);
                }

                // Buat nomor antrean unik sederhana
                const queueNum = clinicPrefix + String(nextQueueNumber++).padStart(3, '0');
                
                const newVisit = { 
                    id: nextVisitId++, 
                    patient_id: patient.id, 
                    doctor_id: body.doctor_id, 
                    visit_date: now.toISOString().split('T')[0], 
                    queue_number: queueNum, 
                    status: 'waiting', 
                    registered_at: `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`
                };
                mockVisits.push(newVisit);

                return { 
                    visit: newVisit, 
                    patient: patient,
                    doctor: findById(mockDoctors, body.doctor_id)
                };
            }
            if (method === 'PUT' && endpoint.includes('/next')) {
                const visitId = endpoint.split('/')[2];
                const visit = findById(mockVisits, visitId);
                if (!visit) throw new Error('Antrean tidak ditemukan.');
                
                // Logika sederhana: waiting -> in_progress -> finished
                if (visit.status === 'waiting') visit.status = 'in_progress';
                else if (visit.status === 'in_progress') visit.status = 'finished';
                
                // Simulasi panggilan dokter berikutnya
                if (visit.status === 'finished') {
                    // Coba panggil antrean berikutnya untuk dokter yang sama
                    const nextWaitingVisit = mockVisits.find(v => v.doctor_id === visit.doctor_id && v.status === 'waiting');
                    if (nextWaitingVisit) {
                         nextWaitingVisit.status = 'in_progress'; // Otomatis panggil berikutnya
                    }
                }
                
                return visit;
            }
        }
        
        throw new Error(`Endpoint ${endpoint} not mocked.`);

    } catch (error) {
        showToast(`MOCK Error: ${error.message}`, true);
        throw error;
    }
}

// Ganti nama apiRequest di semua tempat dengan mockApiRequest
const apiRequest = mockApiRequest; 


// --- UTILITIES (SISANYA SAMA) ---
function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg max-w-sm ${isError ? 'bg-red-500' : 'bg-green-500'}`;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.classList.add('hidden'), 300);
    }, 5000);
}

function openConfirmModal(title, message, onConfirm) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    const modal = document.getElementById('confirm-modal');
    const okBtn = document.getElementById('confirm-ok-btn');
    const cancelBtn = document.getElementById('confirm-cancel-btn');
    
    // Clear previous listeners
    const newOkBtn = okBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    const close = () => { modal.classList.add('hidden'); };
    
    newOkBtn.addEventListener('click', () => { onConfirm(); close(); });
    newCancelBtn.addEventListener('click', close);
    
    modal.classList.remove('hidden');
}

function getDoctorNameById(id) {
    const doctor = mockDoctors.find(d => d.id == id);
    return doctor ? `Dr. ${doctor.name} (${doctor.specialization})` : `Dokter ID ${id}`;
}

function getClinicNameById(id) {
    const clinic = mockServices.find(s => s.id == id);
    return clinic ? clinic.name : `Klinik ID ${id}`;
}

function getPatientNameById(id) {
    const patient = mockPatients.find(p => p.id == id);
    return patient ? patient.name : `Pasien ID ${id}`;
}

function getQueueStatusText(status) {
    switch(status) {
        case 'waiting': return '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Menunggu</span>';
        case 'in_progress': return '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Dilayani</span>';
        case 'finished': return '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Selesai</span>';
        case 'cancelled': return '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Batal</span>';
        default: return status;
    }
}


// --- DATA FETCHING & INITIALIZATION ---
async function fetchAllAdminData() {
    try {
        // Panggil mock data
        servicesCache = await apiRequest('/clinics/'); 
        doctorsCache = await apiRequest('/doctors/'); 
        
        renderServiceTable();
        renderDoctorTable();
        renderRegistrationServiceOptions();
        renderClinicSelectOptions();
        
    } catch(error) {
        console.error("Gagal memuat data admin:", error);
    }
}

async function fetchDashboardData() {
    try {
        const grid = document.getElementById('dashboard-grid');
        grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Memuat data...</p>';

        const clinics = await apiRequest('/clinics/');
        grid.innerHTML = '';

        if (clinics.length === 0) {
            grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Belum ada data klinik untuk ditampilkan.</p>';
            return;
        }
        
        // Panggil mock visits untuk simulasi
        const allVisits = await apiRequest(`/visits/?date_filter=today`); // Filter di mock

        clinics.forEach(clinic => {
            const doctorsInClinic = doctorsCache.filter(d => d.clinic_id == clinic.id);
            const doctorsCount = doctorsInClinic.length;
            const maxPatientsTotal = doctorsInClinic.reduce((sum, d) => sum + 20, 0); 
            
            const clinicVisits = allVisits.filter(v => 
                doctorsInClinic.some(d => d.id == v.doctor_id)
            );
            
            const totalPatientsToday = clinicVisits.length;
            const patientsWaiting = clinicVisits.filter(v => v.status === 'waiting').length;
            const patientsServing = clinicVisits.filter(v => v.status === 'in_progress').length;
            
            const density = maxPatientsTotal > 0 ? (totalPatientsToday / maxPatientsTotal) * 100 : 0;
            const percentage = Math.round(density > 100 ? 100 : density);
            
            let color = percentage > 75 ? 'red' : percentage > 50 ? 'yellow' : 'green';
            
            grid.innerHTML += `<div class="bg-white p-5 rounded-lg shadow card-hover transition-all duration-300">
                <div class="flex justify-between items-start"><h3 class="font-bold text-lg text-gray-800">${clinic.name}</h3><i class="fas fa-clinic-medical text-gray-300 text-2xl"></i></div>
                <p class="text-sm text-gray-500">${doctorsCount} Dokter Bertugas</p>
                <div class="my-4">
                    <div class="flex justify-between items-center text-sm mb-1">
                        <span class="font-semibold">Kepadatan</span>
                        <span class="font-bold text-${color}-600">${percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-${color}-500 h-2.5 rounded-full" style="width: ${percentage > 100 ? 100 : percentage}%"></div>
                    </div>
                </div>
                <div class="text-sm space-y-2 text-gray-700">
                    <div class="flex justify-between"><span>Total Pasien:</span> <span class="font-semibold">${totalPatientsToday}</span></div>
                    <div class="flex justify-between"><span>Menunggu:</span> <span class="font-semibold text-yellow-600">${patientsWaiting}</span></div>
                    <div class="flex justify-between"><span>Dilayani:</span> <span class="font-semibold text-blue-600">${patientsServing}</span></div>
                </div>
            </div>`;
        });
        // Karena Tailwind menggunakan purging, warna harus ditulis lengkap, contoh: text-green-600, bukan hanya 'green' di template string.
    } catch (error) {}
}


// --- VIEW SWITCHING ---
function switchView(viewName) {
    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
    document.getElementById(`${viewName}-view`).classList.add('active');
    document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active-tab'));
    document.querySelector(`.tab-button[data-view="${viewName}"]`).classList.add('active-tab');
    
    if (viewName === 'admin') {
        fetchAllAdminData();
    } else if (viewName === 'public') {
        // Logic Public View
        const firstClinicId = document.querySelector('#clinic-select option:not([value=""])')?.value;
        if(firstClinicId) {
            document.getElementById('clinic-select').value = firstClinicId;
            fetchQueueForClinic(firstClinicId);
        } else {
             document.getElementById('queue-table-body').innerHTML = `<tr class="text-center"><td colspan="4" class="py-4 text-gray-500">Buat layanan di tab Manajemen Admin terlebih dahulu.</td></tr>`;
        }
    } else if (viewName === 'dashboard') {
        fetchDashboardData();
    }
}


// --- ADMIN: SERVICES/CLINICS ---
function renderServiceTable() {
    // ... (Fungsi renderServiceTable sama, hanya menggunakan mockServices)
    const container = document.getElementById('service-table-body');
    container.innerHTML = '';
    if(mockServices.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-gray-500">Belum ada layanan (klinik) yang ditambahkan.</div>`;
        return;
    }
    mockServices.forEach(s => {
        container.innerHTML += `
            <div class="flex items-center px-4 py-3 hover:bg-gray-50">
                <div class="flex-1 font-medium text-gray-800">${s.name}<div class="text-xs text-gray-500">${s.location || 'N/A'}</div></div>
                <div class="w-24 text-right text-sm font-medium">
                    <button onclick="openServiceModal(${s.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                    <button onclick="confirmDeleteService(${s.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                </div>
            </div>
        `;
    });
}

function openServiceModal(serviceId = null) {
    const form = document.getElementById('service-form'); form.reset();
    document.getElementById('service-id').value = '';
    const modalTitle = document.getElementById('service-modal-title');
    if (serviceId) {
        const service = mockServices.find(s => s.id == serviceId);
        modalTitle.textContent = 'Edit Layanan (Klinik)';
        document.getElementById('service-id').value = service.id;
        document.getElementById('service-name').value = service.name;
        document.getElementById('service-location').value = service.location;
    } else {
        modalTitle.textContent = 'Tambah Layanan (Klinik)';
    }
    document.getElementById('service-modal').classList.remove('hidden');
}

function closeServiceModal() { document.getElementById('service-modal').classList.add('hidden'); }

async function handleServiceFormSubmit(event) {
    event.preventDefault();
    const serviceId = document.getElementById('service-id').value;
    const serviceData = { 
        name: document.getElementById('service-name').value, 
        location: document.getElementById('service-location').value 
    };
    try {
        if (serviceId) {
            await apiRequest(`/clinics/${serviceId}`, 'PUT', serviceData);
            showToast('Klinik berhasil diperbarui (MOCK).');
        } else {
            await apiRequest('/clinics/', 'POST', serviceData);
            showToast('Klinik berhasil ditambahkan (MOCK).');
        }
        closeServiceModal();
        fetchAllAdminData();
        fetchDashboardData();
    } catch(error) {}
}

function confirmDeleteService(serviceId) {
    openConfirmModal('Hapus Klinik?', 'Menghapus klinik akan me-null-kan `clinic_id` pada dokter terkait. Anda yakin?', () => deleteService(serviceId));
}

async function deleteService(serviceId) {
    try {
        await apiRequest(`/clinics/${serviceId}`, 'DELETE');
        showToast('Klinik berhasil dihapus (MOCK).');
        fetchAllAdminData();
        fetchDashboardData();
    } catch(error) {}
}

// --- ADMIN: DOCTORS ---
function renderDoctorTable() {
    // ... (Fungsi renderDoctorTable sama, hanya menggunakan mockDoctors)
    const container = document.getElementById('doctor-table-body');
    container.innerHTML = '';
    if(mockDoctors.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-gray-500">Belum ada dokter yang ditambahkan.</div>`;
        return;
    }
    mockDoctors.forEach(d => {
        const clinicName = getClinicNameById(d.clinic_id);

        container.innerHTML += `
            <div class="flex items-center px-4 py-3 hover:bg-gray-50">
                <div class="flex-1">
                    <div class="font-medium text-gray-800">Dr. ${d.name}</div>
                    <div class="text-xs text-gray-500">${d.specialization || 'Umum'}</div>
                </div>
                <div class="w-28 text-center text-sm text-blue-600 font-semibold">${clinicName}</div>
                <div class="w-24 text-right text-sm font-medium">
                    <button onclick="openDoctorModal(${d.id})" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                    <button onclick="confirmDeleteDoctor(${d.id})" class="text-red-600 hover:text-red-800">Hapus</button>
                </div>
            </div>
        `;
    });
}

function renderDoctorClinicOptions(selectedClinicId = null) {
    const select = document.getElementById('doctor-clinic-id');
    select.innerHTML = '<option value="">-- Pilih Klinik --</option>';
    mockServices.forEach(clinic => {
        const option = document.createElement('option');
        option.value = clinic.id;
        option.textContent = clinic.name;
        if (selectedClinicId && clinic.id == selectedClinicId) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function openDoctorModal(doctorId = null) {
    const form = document.getElementById('doctor-form'); form.reset();
    document.getElementById('doctor-id').value = '';
    const modalTitle = document.getElementById('doctor-modal-title');
    if (doctorId) {
        const doctor = mockDoctors.find(d => d.id == doctorId);
        modalTitle.textContent = 'Edit Dokter';
        document.getElementById('doctor-id').value = doctor.id;
        document.getElementById('doctor-name').value = doctor.name;
        document.getElementById('doctor-specialization').value = doctor.specialization;
        renderDoctorClinicOptions(doctor.clinic_id);
    } else {
        modalTitle.textContent = 'Tambah Dokter';
        renderDoctorClinicOptions();
    }
    document.getElementById('doctor-modal').classList.remove('hidden');
}

function closeDoctorModal() { document.getElementById('doctor-modal').classList.add('hidden'); }

async function handleDoctorFormSubmit(event) {
    event.preventDefault();
    const doctorId = document.getElementById('doctor-id').value;
    
    const clinicIdValue = document.getElementById('doctor-clinic-id').value;
    const doctorData = { 
        name: document.getElementById('doctor-name').value, 
        specialization: document.getElementById('doctor-specialization').value, 
        clinic_id: clinicIdValue ? parseInt(clinicIdValue) : null,
        is_active: true
    };
    
    try {
        if (doctorId) {
            await apiRequest(`/doctors/${doctorId}`, 'PUT', doctorData);
            showToast('Data dokter berhasil diperbarui (MOCK).');
        } else {
            await apiRequest('/doctors/', 'POST', doctorData);
            showToast('Dokter baru berhasil ditambahkan (MOCK).');
        }
        closeDoctorModal();
        fetchAllAdminData();
    } catch(error) {}
}

function confirmDeleteDoctor(doctorId) {
    openConfirmModal('Hapus Dokter?', 'Apakah Anda yakin ingin menghapus data dokter ini?', () => deleteDoctor(doctorId));
}

async function deleteDoctor(doctorId) {
    try {
        await apiRequest(`/doctors/${doctorId}`, 'DELETE');
        showToast('Dokter berhasil dihapus (MOCK).');
        fetchAllAdminData();
    } catch(error) {}
}


// --- PATIENT REGISTRATION & QR CODE ---
function renderRegistrationServiceOptions() {
    const container = document.getElementById('service-options-container');
    container.innerHTML = '';
    if (mockServices.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Belum ada layanan yang tersedia. Silakan buat di tab Manajemen Admin.</p>';
        return;
    }
    mockServices.forEach(s => {
        container.innerHTML += `
            <div class="flex items-center">
                <input type="radio" id="service-${s.id}" name="selected-service" value="${s.id}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" onchange="renderRegistrationDoctorOptions(${s.id})" required>
                <label for="service-${s.id}" class="ml-3 block text-sm font-medium text-gray-700">${s.name} <span class="text-xs text-gray-500">(${s.location})</span></label>
            </div>
        `;
    });
}

function renderRegistrationDoctorOptions(clinicId) {
    const container = document.getElementById('doctor-options-container');
    const doctorChoiceDiv = document.getElementById('doctor-choice-container');
    container.innerHTML = '';
    doctorChoiceDiv.classList.remove('hidden');
    
    const availableDoctors = mockDoctors.filter(d => d.clinic_id == clinicId);

    if (availableDoctors.length === 0) {
        container.innerHTML = '<p class="text-sm text-red-600">Tidak ada dokter bertugas di klinik ini.</p>';
        return;
    }

    availableDoctors.forEach(d => {
        container.innerHTML += `
            <div class="flex items-center p-2 bg-white rounded-lg border hover:border-blue-500 transition-all duration-200">
                <input type="radio" id="doctor-${d.id}" name="selected-doctor" value="${d.id}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" required>
                <label for="doctor-${d.id}" class="ml-3 block text-sm font-medium text-gray-700">Dr. ${d.name} <span class="text-xs text-gray-500">(${d.specialization})</span></label>
            </div>
        `;
    });
}

async function handleRegistrationFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    
    const selectedDoctorId = form.elements['selected-doctor']?.value;

    if (!selectedDoctorId) {
        showToast('Error: Harap pilih Layanan dan Dokter.', true);
        return;
    }

    const registrationData = {
        patient_name: document.getElementById('patient-name').value,
        patient_nik: document.getElementById('patient-nik').value,
        patient_dob: document.getElementById('patient-dob').value,
        patient_gender: document.getElementById('patient-gender').value,
        patient_phone: document.getElementById('patient-phone').value,
        doctor_id: parseInt(selectedDoctorId)
    };

    try {
        const result = await apiRequest('/visits/register', 'POST', registrationData);
        
        // Tampilkan modal hasil QR Code
        document.getElementById('qr-queue-number').textContent = result.visit.queue_number;
        document.getElementById('qr-patient-name').textContent = result.patient.name;
        document.getElementById('qr-doctor-name').textContent = `Dr. ${result.doctor.name} (${result.doctor.specialization})`;
        document.getElementById('qr-visit-date').textContent = new Date(result.visit.visit_date).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});

        // Generate QR Code (Contoh: isinya adalah nomor antrean dan NIK)
        const qrcodeContainer = document.getElementById('qrcode-container');
        qrcodeContainer.innerHTML = ''; // Clear previous QR
        new QRCode(qrcodeContainer, {
            text: `Antrean:${result.visit.queue_number}|NIK:${result.patient.nik}`,
            width: 150,
            height: 150,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        document.getElementById('qrcode-result-modal').classList.remove('hidden');
        form.reset();
        document.getElementById('doctor-choice-container').classList.add('hidden');
        showToast('Pendaftaran antrean berhasil (MOCK)!');
    } catch (error) {
        // Error sudah di-handle di apiRequest
    }
}


// --- PUBLIC QUEUE DISPLAY ---
function renderClinicSelectOptions() {
    const select = document.getElementById('clinic-select');
    select.innerHTML = '<option value="">-- Pilih Klinik --</option>';
    mockServices.forEach(clinic => {
        const option = document.createElement('option');
        option.value = clinic.id;
        option.textContent = clinic.name;
        select.appendChild(option);
    });
}

async function fetchQueueForClinic(clinicId) {
    const tableBody = document.getElementById('queue-table-body');
    const clinicNameDisplay = document.getElementById('queue-clinic-name');
    const dateDisplay = document.getElementById('queue-date');
    
    if (!clinicId) {
        clinicNameDisplay.textContent = 'Pilih sebuah klinik';
        dateDisplay.textContent = '';
        tableBody.innerHTML = `<tr class="text-center"><td colspan="4" class="py-4 text-gray-500">Pilih klinik di atas untuk melihat antrean.</td></tr>`;
        return;
    }
    
    clinicNameDisplay.textContent = getClinicNameById(clinicId);
    dateDisplay.textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    tableBody.innerHTML = `<tr class="text-center"><td colspan="4" class="py-4 text-gray-500">Memuat data antrean...</td></tr>`;

    try {
        const allVisits = await apiRequest(`/visits/?date_filter=today`);
        
        // Filter kunjungan untuk klinik yang dipilih (berdasarkan dokter yang terkait)
        const doctorsInClinic = mockDoctors.filter(d => d.clinic_id == clinicId).map(d => d.id);
        
        let queueData = allVisits
            .filter(v => doctorsInClinic.includes(v.doctor_id))
            .sort((a, b) => a.id - b.id); // Urut berdasarkan ID pendaftaran (simulasi urutan waktu)

        renderQueueTable(queueData);

    } catch (error) {
        tableBody.innerHTML = `<tr class="text-center"><td colspan="4" class="py-4 text-red-500">Gagal memuat antrean: ${error.message}</td></tr>`;
    }
}

function renderQueueTable(queueData) {
    const tableBody = document.getElementById('queue-table-body');
    tableBody.innerHTML = '';

    if (queueData.length === 0) {
        tableBody.innerHTML = `<tr class="text-center"><td colspan="4" class="py-4 text-gray-500">Tidak ada antrean hari ini.</td></tr>`;
        return;
    }

    queueData.forEach(q => {
        const statusText = getQueueStatusText(q.status);
        const actionButton = q.status === 'waiting' || q.status === 'in_progress' ? 
            `<button onclick="callNextQueue(${q.id}, '${q.status}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-xs">${q.status === 'waiting' ? 'Panggil' : 'Selesai'}</button>` : 
            `<span class="text-gray-400 text-xs">Selesai</span>`;

        tableBody.innerHTML += `
            <tr class="hover:bg-gray-50 ${q.status === 'in_progress' ? 'bg-blue-50' : ''}">
                <td class="py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    <span class="text-xl font-bold text-blue-800">${q.queue_number}</span>
                    <div class="text-xs text-gray-500">(${getDoctorNameById(q.doctor_id)})</div>
                </td>
                <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-500">${q.registered_at}</td>
                <td class="py-3 px-4 whitespace-nowrap">${statusText}</td>
                <td class="py-3 px-4 whitespace-nowrap text-right">${actionButton}</td>
            </tr>
        `;
    });
}

async function callNextQueue(visitId, currentStatus) {
    try {
        const action = currentStatus === 'waiting' ? 'Memanggil' : 'Menyelesaikan';
        const result = await apiRequest(`/visits/${visitId}/next`, 'PUT');
        
        showToast(`${action} antrean ${result.queue_number} berhasil (MOCK). Status: ${result.status}`);
        
        // Refresh tampilan
        const selectedClinicId = document.getElementById('clinic-select').value;
        if(selectedClinicId) {
            fetchQueueForClinic(selectedClinicId);
        }
        fetchDashboardData();
    } catch (error) {
        // Error sudah di-handle di apiRequest
    }
}


// --- INITIATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Tambahkan event listeners untuk form di modal (tetap gunakan fungsi asli)
    document.getElementById('service-form').addEventListener('submit', handleServiceFormSubmit);
    document.getElementById('doctor-form').addEventListener('submit', handleDoctorFormSubmit);
    document.getElementById('registration-form').addEventListener('submit', handleRegistrationFormSubmit);
    
    // Inisialisasi data di awal
    fetchAllAdminData();
    
    // Tampilkan dashboard
    switchView('dashboard'); 
});

</script>
</body>
</html>